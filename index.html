<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç(‡πë‚Ä¢ . ‚Ä¢‡πë)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Apply dark mode based on system preference
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
</head>

<body class="min-h-screen bg-[#e6ecf0] dark:bg-[#181a1b] py-6 text-gray-900 dark:text-gray-100 transition-all duration-200">
    <div class="max-w-2xl mx-auto p-6 bg-white dark:bg-[#292c2e] rounded-lg shadow-lg mb-8">
        <noscript>
            <p class="text-red-500 opacity-75 mb-4">JavaScript is disabled. Please enable JavaScript to use this page.
            </p>
        </noscript>
        <!-- Title and Input -->
        <div class="py-6">
            <div class="text-center mb-4">
                <a href="/"
                    class="text-5xl font-bold text-teal-700 dark:text-teal-500 hover:text-teal-800 dark:hover:text-teal-600 transition-all duration-300">skeb
                    info
                </a>
            </div>
            <div class="text-4xl mb-4 text-center">
                <span id="tinyko-item" class="inline-block cursor-default select-none">üîç</span><span id="tinyko"
                    class="inline-block cursor-pointer select-none">
                    (‡πë‚Ä¢ . ‚Ä¢‡πë)
                </span>
            </div>
        </div>
        <div class="py-2 px-4">
            <div class="mb-4 relative">
                <input id="username" type="text" placeholder="Skeb link or username" oninput="restore()"
                    class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500 dark:focus:ring-cyan-400 pr-10" />
                <button id="clearInput" type="button"
                    class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                    onclick="clearInput()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <button id="search" onclick="fetchUserInfo()"
                class="w-full bg-[#28837f] text-white p-2 rounded hover:bg-[#206966] dark:hover:bg-[#206966] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Search</button>
        </div>

        <!-- Result Area -->
        <div id="error-message" class="mt-8"></div>
        <div id="user-info" class="mt-8"></div>
        <div id="sent-works-info" class="mt-8"></div>
        <div id="received-works-info" class="mt-8"></div>
        <div id="wishlist-div" class="mt-8"></div>
    </div>
    <script>
        const bookmarkRegularSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="w-7 h-7 fill-gray-500 dark:fill-gray-400 hover:fill-gray-600 hover:dark:fill-gray-300 transition-all duration-360" onClick="toggleBookmark()">
            <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
            <path d="M0 48C0 21.5 21.5 0 48 0l0 48 0 393.4 130.1-92.9c8.3-6 19.6-6 27.9 0L336 441.4 336 48 48 48 48 0 336 0c26.5 0 48 21.5 48 48l0 440c0 9-5 17.2-13 21.3s-17.6 3.4-24.9-1.8L192 397.5 37.9 507.5c-7.3 5.2-16.9 5.9-24.9 1.8S0 497 0 488L0 48z"/>
            </svg>`
        const bookmarkFilledSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="w-7 h-7 fill-gray-500 dark:fill-gray-400 hover:fill-gray-600 hover:dark:fill-gray-300 transition-all duration-360" onClick="toggleBookmark()">
            <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
            <path d="M0 48V487.7C0 501.1 10.9 512 24.3 512c5 0 9.9-1.5 14-4.4L192 400 345.7 507.6c4.1 2.9 9 4.4 14 4.4c13.4 0 24.3-10.9 24.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5 0 0 21.5 0 48z"/>
            </svg>`
        const tinyko = document.getElementById("tinyko");
        const tinykoItem = document.getElementById("tinyko-item");
        const urlUserName = window.location.pathname.slice(2);
        const userNameInput = document.getElementById('username')
        const searchButton = document.getElementById('search');
        const errorMessageDiv = document.getElementById('error-message');
        const userInfoDiv = document.getElementById('user-info');
        const sentWorksDiv = document.getElementById('sent-works-info');
        const receivedWorksDiv = document.getElementById('received-works-info');
        const wishlistDiv = document.getElementById('wishlist-div');
        let currentUser = null;

        // tinyko (‡πë‚Ä¢ . ‚Ä¢‡πë)
        let tnkBeforeState = tinyko.innerHTML;
        tinyko.addEventListener("click", () => {
            if (tinyko.classList.contains("animate__rubberBand")) {
                return;
            }
            tnkBeforeState = tinyko.innerHTML;
            tinyko.classList.add("animate__animated", "animate__rubberBand");
            setTimeout(() => {
                tinyko.innerHTML = "(‡πë>.<‡πë)";
            }, 100);
        });
        tinyko.addEventListener('animationend', () => {
            tinyko.classList.remove("animate__animated", "animate__rubberBand");
            tinyko.innerHTML = tnkBeforeState;
        });
        userNameInput.value = urlUserName;
        const searchButtonDefaultClasses = searchButton.className;
        document.title = `${urlUserName}${urlUserName ? "‚ÄÉ- " : ""}üîç(‡πë‚Ä¢ . ‚Ä¢‡πë)`;
        if (urlUserName) fetchUserInfo();
        // tinyko item
        tinykoItem.addEventListener("click", () => {
            tinykoItem.classList.add("scale-[0.86]", "transition-transform", "duration-100", "ease-in-out");
            setTimeout(() => {
                tinykoItem.classList.remove("scale-[0.86]");
            }, 100);
        });

        // input enter
        userNameInput.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                !searchButton.disabled && fetchUserInfo();
                document.getElementById('username').blur();
            }
        });
        function clearInput() {
            userNameInput.value = '';
            userNameInput.focus();
            restore();
        }
        function restore() {
            errorMessageDiv.innerHTML = "";
            searchButton.className = searchButtonDefaultClasses;
            searchButton.textContent = "Search";
            searchButton.disabled = false;
            tinyko.innerHTML = "(‡πë‚Ä¢ . ‚Ä¢‡πë)";
            tinykoItem.innerHTML = "üîç";
            tinykoItem.classList.remove("animate__animated", "animate__infinite", "animate__bounceIn", "animate__pulse");
        }
        function fadeIn(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add("animate__animated", "animate__fadeIn");
            setTimeout(() => {
                element.classList.remove("animate__animated", "animate__fadeIn");
            }, 500);
        }
        function flash(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add("animate__animated", "animate__flash");
            setTimeout(() => {
                element.classList.remove("animate__animated", "animate__flash");
            }, 500);
        }

        function highlightOn(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add("bg-gray-100", "dark:bg-gray-700", "transition-all", "duration-360");
        }

        function highlightOff(elementId) {
            const element = document.getElementById(elementId);
            element.classList.remove("bg-gray-100", "dark:bg-gray-700");
        }
        function fadeOut(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add("animate__animated", "animate__fadeOut");
            setTimeout(() => {
                element.classList.remove("animate__animated", "animate__fadeOut");
            }, 500);
        }
        function disableSearchButton() {
            searchButton.disabled = true;
            searchButton.classList.remove('hover:bg-[#206966]', 'dark:hover:bg-[#206966]')
        }
        function toggleWishlistFold(fold) {
            const wishlistTableDiv = document.getElementById('wishlist-table-div');
            const updateAllButton = document.getElementById('update-all');
            const foldIcon = document.getElementById('wishlist-fold');
            const expand = document.getElementById('wishlist-expand');

            if (!wishlistTableDiv || !updateAllButton || !foldIcon || !expand) {
                console.error('One or more DOM elements not found');
                return;
            }

            const shouldFold = fold !== undefined
                ? fold
                : !wishlistTableDiv.classList.contains('hidden');

            if (shouldFold) {
                wishlistTableDiv.classList.add('hidden');
                foldIcon.classList.remove('hidden');
                expand.classList.add('hidden');
                updateAllButton.classList.add('hidden');
            } else {
                wishlistTableDiv.classList.remove('hidden');
                foldIcon.classList.add('hidden');
                expand.classList.remove('hidden');
                updateAllButton.classList.remove('hidden');
            }
        }
        async function fetchUserInfo() {
            const wishlistCreators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
            sentWorksDiv.innerHTML = "";
            receivedWorksDiv.innerHTML = "";
            try {
                const usernameInputValue = userNameInput.value.trim();
                let username = usernameInputValue;
                if (username.startsWith('https://skeb.jp/')) {
                    username = username.split('/works/')[0].replace('https://skeb.jp/@', '');
                } else if (username.startsWith('https://x.com/')) {
                    username = username.replace('https://x.com/', '');
                } else if (username.startsWith('https://misskey.io/')) {
                    username = username.replace('https://misskey.io/@', '');
                }
                if (username.startsWith('@')) {
                    username = username.slice(1);
                }
                username = username.replace(/\s+/g, '_');
                username = username.split('?')[0];
                if (!username) {
                    throw new Error('Username required');
                }
                const isValidUsername = /^[a-zA-Z0-9_]+$/.test(username);
                if (!isValidUsername) {
                    throw new Error('Incorrect username format');
                } else {
                    document.getElementById('username').value = username;
                    history.pushState({}, '', `@${username}`);
                    document.title = `${username}‚ÄÉ- üîç(‡πë‚Ä¢ . ‚Ä¢‡πë)`;
                }
                disableSearchButton();
                tinykoItem.classList.add("animate__animated", "animate__infinite", "animate__pulse");
                searchButton.textContent = 'Loading...';
                // await new Promise(resolve => setTimeout(resolve, 2000)); // test loading state
                const response = await fetch(`/api/users/${username}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Unknown error');
                } else {
                    restore();
                }
                tinykoItem.classList.remove("animate__animated", "animate__infinite", "animate__pulse");
                currentUser = await response.json();
                if (currentUser.error) {
                    throw new Error(currentUser.error);
                }

                console.info("Raw user data is below üìë(‡πë‚Ä¢ . ‚Ä¢‡πë)")
                console.log(currentUser)

                const twitterScreenName = currentUser.user_service_links?.[0]?.screen_name || null;
                const misskeyScreenName = currentUser.user_service_links?.find(link => link.provider === "misskey_io")?.screen_name || null;
                let bookmarkSVG = wishlistCreators.some(creator => creator.screen_name === currentUser.screen_name) ? bookmarkFilledSVG : bookmarkRegularSVG;

                const links = {
                    twitter_url: twitterScreenName ? `https://x.com/${twitterScreenName}` : null,
                    misskey_url: misskeyScreenName ? `https://misskey.io/@${misskeyScreenName}` : null,
                    pixiv_url: currentUser.pixiv_id ? `https://www.pixiv.net/users/${currentUser.pixiv_id}` : null,
                    booth_url: currentUser.booth_id ? `https://${currentUser.booth_id}.booth.pm` : null,
                    fantia_url: currentUser.fantia_id ? `https://fantia.jp/fanclubs/${currentUser.fantia_id}` : null,
                    fanbox_url: currentUser.fanbox_id ? `https://${currentUser.fanbox_id}.fanbox.cc` : null,
                    nijie_url: currentUser.nijie_id ? `https://nijie.info/members.php?id=${currentUser.nijie_id}` : null,
                    dlsite_url: currentUser.dlsite_id ? `https://www.dlsite.com/home/circle/profile/=/maker_id/${currentUser.dlsite_id}` : null,
                    fanza_url: currentUser.fanza_id ? `https://www.dmm.co.jp/dc/doujin/-/list/=/article=maker/id/${currentUser.fanza_id}` : null,
                    skima_url: currentUser.skima_id ? `https://skima.jp/profile/users/${currentUser.skima_id}` : null,
                    coconala_url: currentUser.coconala_id ? `https://coconala.com/users/${currentUser.coconala_id}` : null,
                    patreon_url: currentUser.patreon_id ? `https://www.patreon.com/${currentUser.patreon_id}` : null,
                    youtube_url: currentUser.youtube_id ? `https://www.youtube.com/${currentUser.youtube_id}` : null,
                    wishlist_url: currentUser.wishlist_id ? `https://www.amazon.jp/hz/wishlist/ls/${currentUser.wishlist_id}` : null,
                };

                // Process skills
                let skillsHtml = '';
                if (currentUser.skills?.length) {
                    skillsHtml = currentUser.skills.map(skill => {
                        const genre = skill.genre;
                        return `<span class="font-bold">${genre}</span>&nbsp;&nbsp;JPY&nbsp;${skill.default_amount}`;
                    }).join('<br>');
                }

                // Convert times from seconds to days
                const avgResponseDays = currentUser.received_requests_average_response_time ? (currentUser.received_requests_average_response_time / 86400).toFixed(2) : null;
                const avgCompletionDays = currentUser.completing_average_time ? (currentUser.completing_average_time / 86400).toFixed(2) : null;

                // Format fields
                const linkClassList = "font-bold text-teal-700 dark:text-teal-500 hover:underline";
                userInfoDiv.innerHTML = `
                    <div class="overflow-x-auto">
                        <div class="py-2 px-4 flex items-center justify-between">
                            <div class="flex items-baseline">
                                ${currentUser.request_master_rank ?
                        `
                                <svg width="24" height="24" viewBox="0 0 640 512" xmlns="http://www.w3.org/2000/svg" class="mr-1">
                                <path fill="${currentUser.request_master_rank <= 3 ? '#ffe08a' : 'currentColor'}" d="M528 448H112c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h416c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16zm64-320c-26.5 0-48 21.5-48 48 0 7.1 1.6 13.7 4.4 19.8L476 239.2c-15.4 9.2-35.3 4-44.2-11.6L350.3 85C361 76.2 368 63 368 48c0-26.5-21.5-48-48-48s-48 21.5-48 48c0 15 7 28.2 17.7 37l-81.5 142.6c-8.9 15.6-28.9 20.8-44.2 11.6l-72.3-43.4c2.7-6 4.4-12.7 4.4-19.8 0-26.5-21.5-48-48-48S0 149.5 0 176s21.5 48 48 48c2.6 0 5.2-.4 7.7-.8L128 416h384l72.3-192.8c2.5.4 5.1.8 7.7.8 26.5 0 48-21.5 48-48s-21.5-48-48-48z"></path>
                                </svg>
                                `
                        : ""}
                                <a href="https://skeb.jp/@${currentUser.screen_name}" target="_blank" class="text-2xl font-bold hover:underline">
                                    ${currentUser.name}
                                </a>
                                ${skillsHtml ? `
                                ${currentUser.acceptable ? `<span class="text-sm font-bold text-green-600 ml-2">seeking</span>` : `<span class="font-bold text-sm text-gray-500 ml-2">stopped</span>`}`
                        : ""}
                            </div>
                            <div id="bookmark">${currentUser.creator ?
                        bookmarkSVG : ""}
                            </div>
                        </div/>
                        <p class="py-2 px-4">${sanitizeDescription(currentUser.description) || '<span class="text-gray-500">no description</span>'}</p>
                        <div class="py-2 px-4 mb-8">
                            ${[
                        currentUser.nsfw_acceptable ? `<span class="font-bold opacity-60">nsfw OK</span>` : null,
                        currentUser.tip_acceptable ? null : `<span class="font-bold opacity-50">Boost NG</span>`,
                        links.twitter_url ? `<a href="${links.twitter_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Twitter</a>` : null,
                        links.misskey_url ? `<a href="${links.misskey_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Misskey</a>` : null,
                        links.pixiv_url ? `<a href="${links.pixiv_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Pixiv</a>` : null,
                        links.booth_url ? `<a href="${links.booth_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Booth</a>` : null,
                        links.fantia_url ? `<a href="${links.fantia_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Fantia</a>` : null,
                        links.fanbox_url ? `<a href="${links.fanbox_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Fanbox</a>` : null,
                        links.nijie_url ? `<a href="${links.nijie_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Nijie</a>` : null,
                        links.dlsite_url ? `<a href="${links.dlsite_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">DLsite</a>` : null,
                        links.fanza_url ? `<a href="${links.fanza_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Fanza</a>` : null,
                        links.skima_url ? `<a href="${links.skima_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Skima</a>` : null,
                        links.coconala_url ? `<a href="${links.coconala_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Coconala</a>` : null,
                        links.patreon_url ? `<a href="${links.patreon_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Patreon</a>` : null,
                        links.youtube_url ? `<a href="${links.youtube_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">YouTube</a>` : null,
                        links.wishlist_url ? `<a href="${links.wishlist_url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Wishlist</a>` : null,
                        currentUser.url ? `<a href="${currentUser.url}" target="_blank" class="font-bold text-teal-700 dark:text-teal-500 hover:underline">Url (${new URL(currentUser.url).hostname.split('.').slice(-2).join('.')})</a>` : null
                    ].filter(Boolean).join(' / ')}
                        </div>
                            <table class="w-full text-left border-collapse">
                            <tbody>
                                ${currentUser.creator ?
                        `<tr class="separator">
                                  <td colspan="4" class="border-t"></td>
                                </tr>` : ""}
                                ${skillsHtml ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                    <th class="py-2 px-4 font-semibold text-sm sm:text-base">Recommended amount</th>
                                    <td class="py-2 px-4 text-sm sm:text-base">${skillsHtml}</td>
                                </tr>` : ""}
                                ${(currentUser.creator && currentUser.accept_expiration_days && currentUser.complete_expiration_days) ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                    <th class="py-2 px-4 font-semibold text-sm sm:text-base">Response / Complete expiration days</th>
                                    <td class="py-2 px-4 text-sm sm:text-base">${currentUser.accept_expiration_days} / ${currentUser.complete_expiration_days}</td>
                                </tr>` : ""}
                                ${(avgResponseDays && avgCompletionDays) ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                    <th class="py-2 px-4 font-semibold text-sm sm:text-base">Response / Complete average days</th>
                                    <td class="py-2 px-4 text-sm sm:text-base">${avgResponseDays} / ${avgCompletionDays}</td>
                                </tr>` : ""}
                                ${currentUser.received_works_count ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                    <th class="py-2 px-4 font-semibold text-sm sm:text-base">Total</th>
                                    <td class="py-2 px-4 text-sm sm:text-base">
                                        ${currentUser.received_works_count}${((p = currentUser.received_private_works_count, n = currentUser.received_nsfw_works_count) =>
                            p || n ? ` (${[p && `priv ${p}`, n && `nsfw ${n}`].filter(Boolean).join(' / ')})` : ''
                        )()
                        }
                                    </td>
                                </tr>` : ""}
                                ${currentUser.complete_rate ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                    <th class="py-2 px-4 font-semibold text-sm sm:text-base">Complete rate</th>
                                    <td class="py-2 px-4 text-sm sm:text-base">${(currentUser.complete_rate * 100).toFixed(0)}%</td>
                                </tr>` : ""}
                                ${currentUser.total_appeals_count ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                  <th class="py-2 px-4 font-semibold text-sm sm:text-base">Sent appeals</th>
                                  <td class="py-2 px-4 text-sm sm:text-base">${currentUser.total_appeals_count}</td>
                                </tr>`: ""}
                                ${currentUser.sent_public_works_count ?
                        `<tr class="separator">
                                    <td colspan="4" class="border-t"></td>
                                </tr>`: ""}
                                ${currentUser.request_master_rank ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                    <th class="py-2 px-4 font-semibold text-sm sm:text-base">Request master rank</th>
                                    <td class="py-2 px-4 text-sm sm:text-base">${currentUser.request_master_rank}</td>
                                </tr>`: ""}
                                ${currentUser.first_requester_rank ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                    <th class="py-2 px-4 font-semibold text-sm sm:text-base">Pioneer rank</th>
                                    <td class="py-2 px-4 text-sm sm:text-base">${currentUser.first_requester_rank}</td>
                                </tr>`: ""}
                                ${currentUser.sent_public_works_count ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                    <th class="py-2 px-4 font-semibold text-sm sm:text-base">Sent Public Requests</th>
                                    <td class="py-2 px-4 text-sm sm:text-base cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition" onclick="fetchClientWorks('${username}', ${currentUser.sent_public_works_count})">
                                    ${currentUser.sent_public_works_count} ${currentUser.sent_first_works_count ? `( first ${currentUser.sent_first_works_count} )` : ""}
                                    </td>
                                </tr>`: ""}
                                ${currentUser.sent_requests_average_cancel_time ?
                        `<tr class="border-t border-gray-300 dark:border-gray-600">
                                    <th class="py-2 px-4 font-semibold text-sm sm:text-base">Sent Requests Average Cancel Time</th>
                                    <td class="py-2 px-4 text-sm sm:text-base">${(currentUser.sent_requests_average_cancel_time / 86400).toFixed(2)} days</td>
                                </tr>`: ""}
                            </tbody>
                        </table>
                    </div>
                `;
                toggleWishlistFold(true);
                fadeIn('user-info');
            } catch (error) {
                handleError(error);
            }
        }

        // Sanitize description to prevent XSS and handle newlines
        function sanitizeDescription(description) {
            if (!description) return null;
            const div = document.createElement('div');
            div.textContent = description;
            return div.innerHTML.replace(/\\n/g, '<br>');
        }

        // Fetch client works
        async function fetchClientWorks(username, total) {
            const sentWorksDiv = document.getElementById('sent-works-info');
            try {
                sentWorksDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 py-2 px-4">Loading sent works...</p>';
                let works = [];
                let nextUrl = `/api/users/${username}/works?role=client&limit=${total}`;
                let subRequestCount = 0;
                while (nextUrl) {
                    subRequestCount++;
                    const response = await fetch(nextUrl);
                    if (!response.ok && response.status !== 206) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to fetch client works');
                    }
                    const responseJson = await response.json();
                    if (!responseJson.data || !responseJson.meta) {
                        throw new Error('Invalid response structure: missing data or meta');
                    }
                    works = works.concat(responseJson.data);
                    nextUrl = responseJson.meta.next;
                    if (subRequestCount >= 5) {
                        break;
                    }
                    sentWorksDiv.innerHTML = `<p class="text-gray-500 dark:text-gray-400 py-2 px-4">Loading sent works (part ${subRequestCount + 1} / ${subRequestCount + responseJson.meta.remain}) ...</p>`;
                }

                console.info("Raw sent works data is below üìö(‡πë‚Ä¢ . ‚Ä¢‡πë)")
                console.log(works)

                // Aggregate requests and tips by creator
                const creatorStats = {};
                for (const work of works) {
                    const creatorPath = work.path.split('/works/')[0]; // Extract creator username from path (e.g., /@TsukimiSD)
                    const creatorName = creatorPath.replace('/@', '');
                    if (!creatorStats[creatorName]) {
                        creatorStats[creatorName] = { requests: 0, tips: 0 };
                    }
                    creatorStats[creatorName].requests += 1;
                    if (work.tipped) {
                        creatorStats[creatorName].tips += 1;
                    }
                }

                // Convert to array and sort
                const sortedCreators = Object.entries(creatorStats)
                    .map(([name, stats]) => ({ name, ...stats }))
                    .sort((a, b) => {
                        if (a.requests !== b.requests) {
                            return b.requests - a.requests;
                        }
                        if (a.tips !== b.tips) {
                            return b.tips - a.tips;
                        }
                    });

                // Generate table
                const tableHtml = `
                    <div class="mt-8">
                        <h2 class="text-l font-bold mb-4 py-2 px-4">Client Requests by Creator</h2>
                        <hr/>
                        <div class="max-h-64 overflow-y-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="border-b border-gray-300 dark:border-gray-600">
                                        <th class="py-2 px-4 font-semibold text-sm sm:text-base">Name</th>
                                        <th class="py-2 px-4 font-semibold text-sm sm:text-base">Tipped / Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedCreators.length ? sortedCreators.map(creator => `
                                        <tr class="border-t border-gray-300 dark:border-gray-600">
                                            <td class="py-2 px-4 text-sm sm:text-base"><a href="https://skeb.jp/@${creator.name}" target="_blank" class="text-teal-700 hover:underline">${creator.name}</a></td>
                                            <td class="py-2 px-4 text-sm sm:text-base">${creator.tips} / ${creator.requests}</td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="3" class="py-2 px-4 text-sm sm:text-base text-gray-500 dark:text-gray-400">No client requests found.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                // Remove loading message and append table
                sentWorksDiv.innerHTML = tableHtml;
            } catch (error) {
                errorMessageDiv.innerHTML = `<p class="text-red-500 dark:text-red-400 py-2 px-4">Error fetching client works: ${error.message}</p>`;
            }
        }

        // Load creators from localStorage
        function loadCreators() {
            const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
            renderCreatorList(creators);
        }

        // Save creators to localStorage
        function saveCreators(creators) {
            localStorage.setItem('skebWishlist', JSON.stringify(creators));
            renderCreatorList(creators);
        }

        // Render creator list
        function renderCreatorList(creators) {
            if (!creators.length) {
                wishlistDiv.innerHTML = '';
                return;
            }

            const tableHtml = `
                <div class="mt-8">
                    <div class="flex items-center justify-between mb-4 py-2 px-4">
                        <div class="cursor-pointer" onClick="toggleWishlistFold()">
                            <span class="text-xl font-bold opacity-60">Wishlist</span>
                            <span id="wishlist-expand" class="inline-block translate-y-1 ml-1">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5 fill-gray-500 dark:fill-gray-400 hover:fill-gray-600 hover:dark:fill-gray-300 transition-all duration-300">
                                    <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                    <path d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"/>
                                </svg>
                            </span>
                            <span id="wishlist-fold" class="inline-block translate-y-1 ml-1 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5 fill-gray-500 dark:fill-gray-400 hover:fill-gray-600 hover:dark:fill-gray-300 transition-all duration-300">
                                    <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                    <path d="M233.4 105.4c12.5-12.5 32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L256 173.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l192-192z"/>
                                </svg>
                            </span>
                        </div>
                        <button id="update-all" onclick="updateAllCreators()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-6 h-6 fill-gray-500 dark:fill-gray-400 hover:fill-gray-600 hover:dark:fill-gray-300 hover:rotate-45 transition-all duration-300" :class="{ 'animate-spin': isRotating }">
                                <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                <path d="M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160 352 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l111.5 0c0 0 0 0 0 0l.4 0c17.7 0 32-14.3 32-32l0-112c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 35.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5zM39 289.3c-5 1.5-9.8 4.2-13.7 8.2c-4 4-6.7 8.8-8.1 14c-.3 1.2-.6 2.5-.8 3.8c-.3 1.7-.4 3.4-.4 5.1L16 432c0 17.7 14.3 32 32 32s32-14.3 32-32l0-35.1 17.6 17.5c0 0 0 0 0 0c87.5 87.4 229.3 87.4 316.7 0c24.4-24.4 42.1-53.1 52.9-83.8c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0l-.1-.1L125.6 352l34.4 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L48.4 288c-1.6 0-3.2 .1-4.8 .3s-3.1 .5-4.6 1z"/>
                            </svg>
                        </button>
                    </div>
                    <hr/>
                    <div id="wishlist-table-div" class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <tbody>
                                ${creators.map((creator, index) => {
                const avgResponseDays = creator.received_requests_average_response_time ? (creator.received_requests_average_response_time / 86400).toFixed(0) : '';
                const avgCompletionDays = creator.completing_average_time ? (creator.completing_average_time / 86400).toFixed(0) : '';
                const acceptExpiration = creator.accept_expiration_days || '';
                const completeExpiration = creator.complete_expiration_days || '';
                const timeInfo = (avgResponseDays || acceptExpiration) ?
                    `${acceptExpiration ? `${acceptExpiration}/${completeExpiration}` : ''} ${avgResponseDays ? `(${avgResponseDays}/${avgCompletionDays})` : ''}` : '';
                const skillsHtml = creator.skills?.length > 1 ?
                    creator.skills.map(skill => `<span class="font-bold">${skill.genre}</span> ${skill.default_amount}`).join('<br>') :
                    `${creator.skills[0].default_amount}`;
                const acceptingStatus = creator.acceptable ?
                    '<span class="inline-block w-2 h-2 rounded-full bg-green-500"></span>' :
                    '<span class="inline-block w-2 h-2 rounded-full bg-gray-500"></span>';
                return `
                    <tr id=${creator.screen_name} class="border-t border-gray-300 dark:border-gray-600 transition-all duration-360">
                        <td class="py-2 px-4 text-sm sm:text-base">
                            ${acceptingStatus}
                            <a href="https://skeb.jp/@${creator.screen_name}" target="_blank" class="text-teal-700 dark:text-teal-500 hover:underline ml-1">${creator.name}</a>
                        </td>
                        <td class="py-2 px-4 text-sm sm:text-base">${skillsHtml}</td>
                        <td class="py-2 px-4 text-sm sm:text-base">${timeInfo}</td>
                        <td class="py-2 px-4 text-sm sm:text-base flex space-x-2 justify-end items-center">
                            <button onclick="moveCreator(${index}, -1)" ${index === 0 ? 'disabled' : ''} class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                </svg>
                            </button>
                            <button onclick="moveCreator(${index}, 1)" ${index === creators.length - 1 ? 'disabled' : ''} class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <button onclick="deleteCreator(${index})" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            wishlistDiv.innerHTML = tableHtml;
        }

        // Add creator to wishlist
        async function addCreator(userData) {
            try {
                if (userData.error) {
                    throw new Error(userData.error);
                }
                if (!userData.creator) {
                    throw new Error('User is not a creator');
                }
                const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
                if (creators.some(c => c.screen_name === userData.screen_name)) {
                    throw new Error('Creator already in wishlist');
                }
                creators.unshift(userData);
                saveCreators(creators);
                restore();
            } catch (error) {
                handleError(error);
            }
        }

        // Update all creators
        async function updateAllCreators() {
            const updateSvg = document.querySelector('#update-all svg');
            const updateAllButton = document.getElementById('update-all');
            // spin
            updateSvg.classList.add('animate-spin');
            updateSvg.classList.remove('hover:rotate-45');
            updateAllButton.disabled = true;
            updateAllButton.classList.add('opacity-50');
            try {
                disableSearchButton();
                searchButton.textContent = 'Updating...';
                tinykoItem.classList.add("animate__animated", "animate__infinite", "animate__pulse");
                const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
                const updatedCreators = [];
                for (const creator of creators) {
                    try {
                        highlightOn(creator.screen_name);
                        const response = await fetch(`api/users/${creator.screen_name}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.creator) {
                                updatedCreators.push(data);
                            } else {
                                updatedCreators.push(creator); // Keep old data if no longer a creator
                            }
                        } else {
                            console.error(`Error fetching data for ${creator.screen_name}: ${response.statusText}`);
                            updatedCreators.push(creator); // Keep old data on error
                        }
                        highlightOff(creator.screen_name);
                    } catch {
                        updatedCreators.push(creator); // Keep old data on error
                    }
                }
                saveCreators(updatedCreators);
                flash("wishlist-table-div");
                restore();
                searchButton.textContent = 'Search';
            } catch (error) {
                console.error("Error updating all creators:", error);
                searchButton.textContent = 'Error';
                searchButton.classList.remove('bg-gray-500', 'hover:bg-gray-600', 'dark:hover:bg-gray-600');
                searchButton.classList.add('bg-red-500', 'opacity-50');
                tinykoItem.innerHTML = '‚ùå';
                tinykoItem.classList.remove("animate__animated", "animate__infinite", "animate__pulse");
                tinykoItem.classList.add("animate__animated", "animate__bounceIn");
                tinyko.innerHTML = "(‡πë>.<‡πë)";
                setTimeout(restore, 2500);
            } finally {
                updateSvg.classList.remove('animate-spin');
                updateSvg.classList.add('hover:rotate-45');
                updateAllButton.disabled = false;
                updateAllButton.classList.remove('opacity-50');
            }
        }

        // Move creator up or down
        function moveCreator(index, direction) {
            const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < creators.length) {
                [creators[index], creators[newIndex]] = [creators[newIndex], creators[index]];
                saveCreators(creators);
            }
        }

        // Delete creator
        function deleteCreator(key) {
            const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
            let index;
            if (typeof key === 'string') {
                index = creators.findIndex(creator => creator.screen_name === key);
            } else {
                index = key;
            }
            if (index < 0 || index >= creators.length) {
                console.error('Invalid index:', index);
                return;
            }
            console.log(`Deleting creator at index ${index}`);
            creators.splice(index, 1);
            saveCreators(creators);
        }

        // Toggle bookmark
        function toggleBookmark() {
            const bookmarkDiv = document.getElementById('bookmark');
            const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
            const creatorIndex = creators.findIndex(creator => creator.screen_name === currentUser.screen_name);
            if (creatorIndex !== -1) {
                // Creator already in wishlist, remove it
                bookmarkDiv.innerHTML = bookmarkRegularSVG;
                deleteCreator(currentUser.screen_name);
            } else {
                // Creator not in wishlist, add it
                bookmarkDiv.innerHTML = bookmarkFilledSVG;
                addCreator(currentUser);
            }
        }

        // Error handling
        function handleError(error) {
            if (error.message.toLowerCase().includes("not found")) {
                searchButton.textContent = 'User not found';
                searchButton.classList.remove('bg-[#28837f]', 'hover:bg-[#206966]', 'dark:hover:bg-[#206966]');
                searchButton.classList.add('bg-gray-600');
                tinykoItem.innerHTML = "‚ùî";
                tinykoItem.classList.remove("animate__animated", "animate__infinite", "animate__pulse");
                tinykoItem.classList.add("animate__animated", "animate__bounceIn");
                document.title = `404‚ÄÉ- üîç(‡πë‚Ä¢ . ‚Ä¢‡πë)`;
                userInfoDiv.innerHTML = "";
            } else {
                searchButton.textContent = 'Error';
                searchButton.classList.remove('bg-[#28837f]', 'hover:bg-[#206966]', 'dark:hover:bg-[#206966]');
                searchButton.classList.add('bg-red-500', 'opacity-50');
                tinykoItem.innerHTML = "‚ùå";
                tinykoItem.classList.remove("animate__animated", "animate__infinite", "animate__pulse");
                tinykoItem.classList.add("animate__animated", "animate__bounceIn");
                tinyko.innerHTML = "(‡πë>.<‡πë)";
                errorMessageDiv.innerHTML = `<p class="text-red-500 dark:text-red-400 py-2 px-4">Error: ${error.message}</p>`;
                setTimeout(restore, 2500);
            }
        }

        // Initial load
        loadCreators();
    </script>
</body>

</html>